-- Switch to the MedicalInfoSystem database
USE MedicalInfoSystem;
GO

-- Create a Column Master Key
CREATE COLUMN MASTER KEY MedicalInfoSystemCMK
WITH (
    KEY_STORE_PROVIDER_NAME = 'MSSQL_CERTIFICATE_STORE', 
    KEY_PATH = 'CurrentUser/My/B4F7EFFD3559C7167772D5AEF0DC7799528CAFD9',
    ENCLAVE_COMPUTATIONS (SIGNATURE = 0x38420EA3FBF5C6A2F76C89331B95C33E7C40D3B4F2026981F8E289652308C6D165C092DE23360F92A576E34915FBD303B20AA2E5AB9B5D2D4684E3A09577783E2E09E44377A26F1DB122536B31EF03DF17E2BB6E2BE1F72C3EF1941E5C683010E70A660F9C39AA9EE241F186F82300ACB417431440BB5926227B80138C874569F6A031F7C35F94902F4E9A32C104B7A805AF725B0F911E5267F766FAC98727923721A8AFD8BCF994E53E41657989667BA05677D93FAC6A22003F0A5AF1E640A6B6D56CEAB491EF28306FBB59B6A6AA252B37A7A351E15616FCE6834304420E41CFAD8B85B981D260DC5567B8913C5829DE135C5B0D89D29E32DE0E2F525B686B)
);
GO

-- Create a Column Encryption Key
CREATE COLUMN ENCRYPTION KEY MedicalInfoSystemCEK
WITH VALUES (
    COLUMN_MASTER_KEY = MedicalInfoSystemCMK, 
    ALGORITHM = 'RSA_OAEP',
	ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F00620034006600370065006600660064003300350035003900630037003100360037003700370032006400350061006500660030006400630037003700390039003500320038006300610066006400390094944B8CEA28D78367BF0C9C4E1B0B8406059AAEBE26D6BC7AC093670470CC0E209B6BAD7FFF418F12133BB18804BEBF46F91DA548B441E228D61C1307678CC25577586DBE68C870348D74067595444BD5F78149DE024986D21F9A8AF293D7C922414666201A7B00D24658C0B359F980158967622CD516BBD507F693C36BB99E239C81B4EB29A22115EB447DEDDEFD330D443ADC41E95F68342D7A9F00217F45B6E4128CD716D07D01FAAF5E604007BAA28718D12C803D11A9F18088593C3BDA7B7181BE9C643191C6770722CF3037036AF8D50D2D54C46AD472A909457C537F59904A3616E8C7D20873D2C076915B049F0018A4054F15642D3A1AF412A4BEC3174CA7A8F18AFBEBCE8775EC28261BA72356101AF764B554E7740CF57B0F6B48EAD73DDF81B37FD0480DBB2DB07F8D17898C1AC1ED7A394644492A375C88F3B3338588F6B0CA7513974EE9E2732F11A5EE12AD1F36B5F71E74A89DC02F90795669B75B9DE2ECC5F7F22B28DF5CDA7D6B4E44F2A52781453951625C3245147F78D7466CDF61F4CE9CBF856F4C1DC137A3442BA171FD8BFC7AC8CE75861257D38D0DCE7607C9B2DF228FDC89DCF08ECEABB868533149A1F24999159A247A7A990984FAC030A8C4D4E110006B8636CECAB44DECBB484546CE2FA1C77B26609DE4F27C854160423637B504A7533714050E2D2CE119950F6095FDC5A1DCBF429E6897
);
GO

-- Alter Patient table to apply encryption to sensitive columns
ALTER TABLE Patient
ALTER COLUMN PName NVARCHAR(100) 
COLLATE Latin1_General_BIN2 
ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = MedicalInfoSystemCEK, ENCRYPTION_TYPE = Deterministic, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256');
GO

ALTER TABLE Patient
ALTER COLUMN PPassportNumber NVARCHAR(50) 
COLLATE Latin1_General_BIN2 
ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = MedicalInfoSystemCEK, ENCRYPTION_TYPE = Deterministic, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256');
GO

ALTER TABLE Patient
ALTER COLUMN PaymentCardNumber NVARCHAR(50) 
COLLATE Latin1_General_BIN2 
ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = MedicalInfoSystemCEK, ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256');
GO

ALTER TABLE Patient
ALTER COLUMN PaymentCardPinCode NVARCHAR(50) 
COLLATE Latin1_General_BIN2 
ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = MedicalInfoSystemCEK, ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256');
GO